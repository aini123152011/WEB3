# WEB3æµ‹è¯•å·¥ç¨‹å¸ˆå®Œå…¨æŒ‡å— - å®‰å…¨æµ‹è¯•ä¸å·¥å…·ç¯‡ ğŸ›¡ï¸

## ç¬¬ä¸€ç« ï¼šå®‰å…¨æµ‹è¯•åŸºç¡€

### 1.1 WEB3å®‰å…¨æµ‹è¯•ç‰¹æ®Šæ€§

**ä¸ä¼ ç»Ÿå®‰å…¨æµ‹è¯•çš„å·®å¼‚**ï¼š
```
ä¼ ç»ŸWebå®‰å…¨          WEB3å®‰å…¨
â”œâ”€ SQLæ³¨å…¥           â”œâ”€ é‡å…¥æ”»å‡»
â”œâ”€ XSSæ”»å‡»           â”œâ”€ æ•´æ•°æº¢å‡º/ä¸‹æº¢
â”œâ”€ CSRF              â”œâ”€ è®¿é—®æ§åˆ¶æ¼æ´
â”œâ”€ æƒé™ç»•è¿‡          â”œâ”€ å‰ç«¯è¿è¡Œ(MEV)
â””â”€ æ•°æ®æ³„éœ²          â””â”€ ç§é’¥æ³„éœ²

é£é™©ï¼šæ•°æ®æŸå       é£é™©ï¼šèµ„é‡‘æ°¸ä¹…æŸå¤±
å¯ä¿®å¤ï¼šæ˜¯           å¯ä¿®å¤ï¼šé€šå¸¸ä¸å¯ä»¥
```

### 1.2 OWASP Smart Contract Top 10ï¼ˆå¿…è®°ï¼‰

1. **SC01: é‡å…¥æ”»å‡» (Reentrancy)**
2. **SC02: è®¿é—®æ§åˆ¶ (Access Control)**
3. **SC03: ç®—æœ¯é—®é¢˜ (Arithmetic Issues)**
4. **SC04: æœªæ£€æŸ¥çš„å¤–éƒ¨è°ƒç”¨ (Unchecked Calls)**
5. **SC05: æ‹’ç»æœåŠ¡ (DoS)**
6. **SC06: ç³Ÿç³•çš„éšæœºæ€§ (Bad Randomness)**
7. **SC07: å‰ç«¯è¿è¡Œ (Front-Running)**
8. **SC08: æ—¶é—´æ“çºµ (Time Manipulation)**
9. **SC09: çŸ­åœ°å€æ”»å‡» (Short Address Attack)**
10. **SC10: æœªçŸ¥æœªçŸ¥ (Unknown Unknowns)**

## ç¬¬äºŒç« ï¼šæ™ºèƒ½åˆçº¦å®‰å…¨æµ‹è¯•å®æˆ˜

### 2.1 é‡å…¥æ”»å‡»æµ‹è¯•

**æ¼æ´ä»£ç **ï¼š
```solidity
// âŒ ä¸å®‰å…¨
contract Vulnerable {
    mapping(address => uint) public balances;
    
    function withdraw() public {
        uint bal = balances[msg.sender];
        (bool sent,) = msg.sender.call{value: bal}("");
        require(sent);
        balances[msg.sender] = 0; // çŠ¶æ€å˜æ›´åœ¨å
    }
}
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```solidity
// test/Reentrancy.t.sol
contract ReentrancyTest {
    function test_reentrancy_exploit() public {
        Attacker attacker = new Attacker(address(vulnerable));
        attacker.attack{value: 1 ether}();
        assertGt(address(attacker).balance, 1 ether); // æ”»å‡»æˆåŠŸ
    }
}

contract Attacker {
    Vulnerable target;
    constructor(address _target) { target = Vulnerable(_target); }
    
    function attack() external payable {
        target.deposit{value: msg.value}();
        target.withdraw();
    }
    
    receive() external payable {
        if (address(target).balance >= 1 ether) {
            target.withdraw(); // é‡å…¥
        }
    }
}
```

**ä¿®å¤éªŒè¯**ï¼š
```solidity
// âœ… å®‰å…¨ï¼šCEIæ¨¡å¼ï¼ˆChecks-Effects-Interactionsï¼‰
function withdraw() public {
    uint bal = balances[msg.sender];
    balances[msg.sender] = 0; // å…ˆæ›´æ–°çŠ¶æ€
    (bool sent,) = msg.sender.call{value: bal}("");
    require(sent);
}
```

### 2.2 è®¿é—®æ§åˆ¶æµ‹è¯•

**æµ‹è¯•çŸ©é˜µ**ï¼š
```typescript
describe("Access Control", () => {
  it("only owner can pause", async () => {
    await expect(contract.connect(attacker).pause())
      .to.be.revertedWith("Ownable: caller is not the owner");
  });
  
  it("minter role required for mint", async () => {
    await expect(contract.connect(user).mint(user.address, 100))
      .to.be.revertedWith("MINTER_ROLE required");
  });

  it("admin can grant roles", async () => {
    await contract.grantRole(MINTER_ROLE, user.address);
    await expect(contract.connect(user).mint(user.address, 100))
      .to.not.be.reverted;
  });
});
```

### 2.3 æ•´æ•°æº¢å‡ºæµ‹è¯•ï¼ˆSolidity <0.8ï¼‰

**æµ‹è¯•æ–¹æ³•**ï¼š
```typescript
it("should not overflow", async () => {
  // å¯¹äºSolidity 0.8+ï¼Œè‡ªåŠ¨å›æ»š
  await expect(contract.increment(ethers.MaxUint256))
    .to.be.revertedWithPanic(0x11); // Arithmetic overflow
});
```

### 2.4 æ—¶é—´ä¾èµ–æµ‹è¯•

**æ¼æ´åœºæ™¯**ï¼šä¾èµ–block.timestampåšå…³é”®åˆ¤æ–­
```typescript
it("should not manipulate time", async () => {
  const currentTime = await time.latest();
  await time.increaseTo(currentTime + 86400); // +1å¤©
  
  // éªŒè¯æ—¶é—´é”æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ
  await expect(contract.withdraw()).to.not.be.reverted;
});
```

### 2.5 å‰ç«¯è¿è¡Œ(Front-Running)æµ‹è¯•

**åœºæ™¯**ï¼šä»·æ ¼é¢„è¨€æœºæ›´æ–°ã€å¤§é¢äº¤æ˜“ã€æ‹å–å‡ºä»·
```typescript
describe("MEV Protection", () => {
  it("should use commit-reveal", async () => {
    const commit = ethers.keccak256(ethers.toUtf8Bytes("bid:1000:salt123"));
    await auction.commitBid(commit); // æäº¤æ‰¿è¯º
    await time.increase(3600);
    await auction.revealBid("bid:1000:salt123"); // æ­ç¤º
  });
});
```

## ç¬¬ä¸‰ç« ï¼šé™æ€åˆ†æå·¥å…·

### 3.1 Slitherï¼ˆPythonï¼‰

**å®‰è£…ä¸ä½¿ç”¨**ï¼š
```bash
pip install slither-analyzer
slither contracts/ --print human-summary
slither contracts/ --detect reentrancy-eth,uninitialized-state
```

**å¸¸è§æ£€æµ‹é¡¹**ï¼š
- reentrancy-eth / reentrancy-no-eth
- uninitialized-state / uninitialized-storage
- arbitrary-send-eth / suicidal
- tx-origin / timestamp

**CIé›†æˆ**ï¼š
```yaml
- name: Slither
  run: |
    pip install slither-analyzer
    slither . --fail-high --json-types detectors
```

### 3.2 Mythrilï¼ˆç¬¦å·æ‰§è¡Œï¼‰

```bash
pip install mythril
myth analyze contracts/Token.sol
```

### 3.3 Solhintï¼ˆä»£ç è§„èŒƒï¼‰

```bash
npm i -D solhint
npx solhint 'contracts/**/*.sol'
```

**é…ç½®ç¤ºä¾‹**ï¼ˆ.solhint.jsonï¼‰ï¼š
```json
{
  "extends": "solhint:recommended",
  "rules": {
    "no-unused-vars": "error",
    "func-visibility": ["error", { "ignoreConstructors": true }],
    "state-visibility": "error",
    "max-line-length": ["warn", 120]
  }
}
```

### 3.4 4naly3erï¼ˆå¤šåˆä¸€ï¼‰

```bash
npm i -g 4naly3er
4naly3er contracts/
```

## ç¬¬å››ç« ï¼šåŠ¨æ€åˆ†æä¸æ¨¡ç³Šæµ‹è¯•

### 4.1 Echidnaï¼ˆå±æ€§æµ‹è¯•ï¼‰

**å®‰è£…**ï¼š
```bash
docker pull trailofbits/eth-security-toolbox
# æˆ–ç¼–è¯‘å®‰è£…ï¼šhttps://github.com/crytic/echidna
```

**å±æ€§å‡½æ•°ç¤ºä¾‹**ï¼š
```solidity
contract TestERC20 is ERC20 {
    function echidna_totalSupply_constant() public view returns (bool) {
        return totalSupply() == 1_000_000e18;
    }
    
    function echidna_balance_geq_zero() public view returns (bool) {
        return balanceOf(msg.sender) >= 0;
    }
}
```

**è¿è¡Œ**ï¼š
```bash
echidna-test contracts/TestERC20.sol --contract TestERC20
```

### 4.2 Foundry Fuzzï¼ˆå†…ç½®ï¼‰

```solidity
function testFuzz_transfer(address to, uint256 amount) public {
    vm.assume(to != address(0) && amount <= 1e24);
    token.transfer(to, amount);
    assertEq(token.balanceOf(to), amount);
}
```

**è¿è¡Œ**ï¼š
```bash
forge test --fuzz-runs 10000
```

### 4.3 Manticoreï¼ˆç¬¦å·æ‰§è¡Œï¼‰

```python
from manticore.ethereum import ManticoreEVM

m = ManticoreEVM()
with open('Token.sol') as f:
    m.solidity_create_contract(f.read())

# æ‰§è¡Œç¬¦å·äº¤æ˜“
m.transaction(caller=m.make_symbolic_address(), 
              address=contract, 
              data=m.make_symbolic_buffer(4+32+32))
```

## ç¬¬äº”ç« ï¼šå®¡è®¡å·¥å…·ä¸æµç¨‹

### 5.1 MythXï¼ˆå•†ä¸šå¹³å°ï¼‰

```bash
npm install -g mythxjs-cli
mythxjs analyze contracts/Token.sol
```

### 5.2 Certoraï¼ˆå½¢å¼åŒ–éªŒè¯ï¼‰

**è§„èŒƒç¤ºä¾‹**ï¼ˆ.specæ–‡ä»¶ï¼‰ï¼š
```
methods {
    function totalSupply() external returns (uint256) envfree;
    function balanceOf(address) external returns (uint256) envfree;
}

invariant totalSupplyEqualsSumOfBalances()
    totalSupply() == sumOfBalances()
```

### 5.3 å®¡è®¡æ¸…å•ï¼ˆChecklistï¼‰

**éƒ¨ç½²å‰å¿…æŸ¥**ï¼š
- [ ] æ‰€æœ‰external/publicå‡½æ•°æœ‰è®¿é—®æ§åˆ¶
- [ ] æ— selfdestructæˆ–è°¨æ…ä½¿ç”¨
- [ ] å¤–éƒ¨è°ƒç”¨æ£€æŸ¥è¿”å›å€¼
- [ ] ä½¿ç”¨æœ€æ–°ç¨³å®šSolidityï¼ˆ0.8+ï¼‰
- [ ] æ‰€æœ‰çŠ¶æ€å˜æ›´éµå¾ªCEIæ¨¡å¼
- [ ] æ•æ„Ÿæ“ä½œæœ‰äº‹ä»¶è®°å½•
- [ ] æµ‹è¯•è¦†ç›–ç‡>90%
- [ ] Slitheræ— é«˜å±/ä¸­å±è­¦å‘Š
- [ ] è‡³å°‘ä¸€æ¬¡å¤–éƒ¨å®¡è®¡ï¼ˆä¸»ç½‘ï¼‰

## ç¬¬å…­ç« ï¼šæµ‹è¯•å·¥å…·ç”Ÿæ€

### 6.1 æœ¬åœ°å¼€å‘èŠ‚ç‚¹

| å·¥å…· | ç‰¹ç‚¹ | ä½¿ç”¨åœºæ™¯ |
|------|------|---------|
| **Hardhat Node** | é›†æˆæ–¹ä¾¿ï¼ŒTypeScriptå‹å¥½ | æ—¥å¸¸å¼€å‘ |
| **Ganache** | å¯è§†åŒ–ç•Œé¢ï¼Œæ˜“ç”¨ | å­¦ä¹ é˜¶æ®µ |
| **Anvil (Foundry)** | é€Ÿåº¦å¿«ï¼ŒåŸç”Ÿåˆ†å‰ | æ€§èƒ½æµ‹è¯• |

```bash
# Hardhat
npx hardhat node

# Anvil
anvil --fork-url $MAINNET_RPC
```

### 6.2 æµ‹è¯•ç½‘æ°´é¾™å¤´è‡ªåŠ¨åŒ–

```typescript
// scripts/faucet.ts
import axios from 'axios';

async function getFaucet(address: string) {
  const response = await axios.post('https://sepolia-faucet.com/api/claim', {
    address,
    token: process.env.FAUCET_TOKEN
  });
  console.log(`Claimed: ${response.data.txHash}`);
}
```

### 6.3 Gasåˆ†æå·¥å…·

```bash
# Hardhat Gas Reporter
npm i -D hardhat-gas-reporter
REPORT_GAS=true npx hardhat test

# Foundry Gas Snapshots
forge snapshot
```

### 6.4 RPCæœåŠ¡å•†å¯¹æ¯”

| æœåŠ¡å•† | å…è´¹é¢åº¦ | ä¸»ç½‘Archive | é€Ÿåº¦ |
|--------|---------|------------|------|
| **Alchemy** | 300M CU/æœˆ | âœ… | å¿« |
| **Infura** | 100K req/å¤© | âŒ | ä¸­ |
| **QuickNode** | æŒ‰éœ€ä»˜è´¹ | âœ… | å¾ˆå¿« |
| **Ankr** | æœ‰é™å…è´¹ | âœ… | ä¸­ |

## ç¬¬ä¸ƒç« ï¼šå®‰å…¨æœ€ä½³å®è·µ

### 7.1 å¼€å‘é˜¶æ®µ

```solidity
// âœ… å¥½çš„æ¨¡å¼
contract Safe {
    // 1. ä½¿ç”¨OpenZeppelinåº“
    using SafeERC20 for IERC20;
    
    // 2. æ˜ç¡®å¯è§æ€§
    uint256 private _value;
    
    // 3. äº‹ä»¶è®°å½•
    event ValueChanged(uint256 oldValue, uint256 newValue);
    
    // 4. CEIæ¨¡å¼
    function withdraw(uint256 amount) external {
        require(balances[msg.sender] >= amount, "Insufficient");
        balances[msg.sender] -= amount; // Effect
        payable(msg.sender).transfer(amount); // Interaction
        emit Withdrawn(msg.sender, amount);
    }
    
    // 5. ä½¿ç”¨modifier
    modifier onlyOwner() {
        require(msg.sender == owner, "Not owner");
        _;
    }
}
```

### 7.2 æµ‹è¯•é˜¶æ®µ

**å¿…é¡»è¦†ç›–çš„åœºæ™¯**ï¼š
```
âœ… æ­£å¸¸æµç¨‹
âœ… è¾¹ç•Œæ¡ä»¶ï¼ˆ0, max, max+1ï¼‰
âœ… å¤±è´¥åœºæ™¯ï¼ˆä½™é¢ä¸è¶³ã€æƒé™ä¸è¶³ï¼‰
âœ… é‡å…¥å°è¯•
âœ… æ—¶é—´ç›¸å…³ï¼ˆè¿‡æœŸã€æœªç”Ÿæ•ˆï¼‰
âœ… å¹¶å‘äº¤æ˜“ï¼ˆnonceã€ç«æ€ï¼‰
âœ… æ¶æ„è¾“å…¥ï¼ˆè¶…é•¿æ•°ç»„ã€é›¶åœ°å€ï¼‰
```

### 7.3 éƒ¨ç½²é˜¶æ®µ

**éƒ¨ç½²å‰æ£€æŸ¥**ï¼š
```bash
# 1. ç¼–è¯‘ä¼˜åŒ–
forge build --optimize --optimizer-runs 200

# 2. å­—èŠ‚ç éªŒè¯
sha256sum out/Contract.sol/Contract.json

# 3. æ„é€ å‚æ•°éªŒè¯
cast abi-encode "constructor(string,uint)" "Token" 1000000

# 4. Gasä¼°ç®—
cast estimate --from $DEPLOYER $DATA
```

## ç¬¬å…«ç« ï¼šåº”æ€¥å“åº”

### 8.1 æš‚åœæœºåˆ¶

```solidity
import "@openzeppelin/contracts/security/Pausable.sol";

contract SafeToken is ERC20, Pausable, Ownable {
    function transfer(...) public whenNotPaused override {
        super.transfer(to, amount);
    }
    
    function pause() external onlyOwner { _pause(); }
    function unpause() external onlyOwner { _unpause(); }
}
```

### 8.2 ç›‘æ§ä¸å‘Šè­¦

```typescript
// ç›‘æ§å¼‚å¸¸äº‹ä»¶
contract.on("EmergencyWithdraw", (user, amount, event) => {
  alert(`CRITICAL: EmergencyWithdraw ${amount} by ${user}`);
});

// ç›‘æ§revertç‡
const tx = await contract.someFunction();
if (!tx.status) {
  metrics.increment('contract.reverts');
}
```

### 8.3 äº‹ä»¶å“åº”æµç¨‹

```
å‘ç°å¼‚å¸¸
    â†“
ç«‹å³æš‚åœåˆçº¦ï¼ˆå¦‚æœ‰Pauseï¼‰
    â†“
é€šçŸ¥æ ¸å¿ƒå›¢é˜Ÿ
    â†“
åˆ†ææ ¹å› ï¼ˆé“¾ä¸Šæ•°æ®ã€äº¤æ˜“å›æ”¾ï¼‰
    â†“
è¯„ä¼°å½±å“èŒƒå›´
    â†“
åˆ¶å®šä¿®å¤æ–¹æ¡ˆ
    â†“
ç¤¾åŒºå…¬å‘Š
    â†“
æ‰§è¡Œä¿®å¤ï¼ˆå¦‚å¯å‡çº§ï¼‰
    â†“
å¤ç›˜ä¸æ”¹è¿›
```

---

## ğŸ“š æœ¬ç« æ€»ç»“

WEB3å®‰å…¨æµ‹è¯•æ˜¯ä¸€ä¸ªæŒç»­è¿­ä»£çš„è¿‡ç¨‹ï¼š

1. **å·¥å…·ä¸ºè¾…ï¼Œç†è§£ä¸ºä¸»**ï¼šå·¥å…·ä¼šè¯¯æŠ¥ï¼Œéœ€äººå·¥åˆ¤æ–­
2. **æ”»å‡»è€…è§†è§’**ï¼šç«™åœ¨é»‘å®¢è§’åº¦æ€è€ƒ
3. **çºµæ·±é˜²å¾¡**ï¼šä»£ç å®¡æŸ¥ã€è‡ªåŠ¨åŒ–æ‰«æã€å¤–éƒ¨å®¡è®¡å¤šå±‚ä¿éšœ
4. **æŒç»­å­¦ä¹ **ï¼šå…³æ³¨å®‰å…¨äº‹ä»¶ï¼Œå­¦ä¹ æ–°æ”»å‡»æ‰‹æ³•

**ä¸‹ä¸€ç« é¢„å‘Š**ï¼šå®æˆ˜æ¡ˆä¾‹åˆ†æä¸é¢è¯•æŒ‡å— ğŸ¯

---

> ğŸ’¡ **å®‰å…¨æ ¼è¨€**ï¼šåœ¨WEB3ï¼Œå®‰å…¨ä¸æ˜¯åŠŸèƒ½ï¼Œè€Œæ˜¯ç”Ÿå‘½çº¿ã€‚æ¯ä¸€è¡Œä»£ç éƒ½å¯èƒ½å…³ç³»åˆ°æ•°ç™¾ä¸‡ç¾å…ƒã€‚
