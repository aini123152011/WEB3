# WEB3测试工程师完全指南 - 自动化测试篇 🤖

## 第一章：自动化测试概览

### 1.1 WEB3自动化与传统自动化的区别

- 需要与区块链节点交互（JSON-RPC）
- 涉及交易签名与异步确认（Pending → Mined → Confirmed）
- 需考虑Gas、Nonce、链状态（时间/区块）
- 多钱包/多链/多网络（主网、测试网、本地）

### 1.2 自动化测试分层

```
┌───────────────────────────┐
│ E2E：前端 + 钱包 + 链       │ Playwright + MetaMask + 私有RPC │
├───────────────────────────┤
│ 合约集成测试               │ Hardhat/Foundry + mainnet fork  │
├───────────────────────────┤
│ 合约单元测试               │ Hardhat/Foundry (Solidity/TS)   │
├───────────────────────────┤
│ 工具/SDK层测试             │ Ethers.js/Web3.js/Viem          │
└───────────────────────────┘
```

## 第二章：合约层自动化（Hardhat/Foundry）

### 2.1 选型建议

- 新项目：Hardhat（生态完善，TS友好）
- 追求极致速度：Foundry（Rust实现，快）
- 两者并用：合约用Foundry，脚本与前端用Hardhat

### 2.2 Hardhat自动化测试模板（TS）

```ts
// test/erc20.spec.ts
import { expect } from "chai";
import { ethers } from "hardhat";

describe("ERC20", () => {
  async function deploy() {
    const [owner, alice, bob] = await ethers.getSigners();
    const Token = await ethers.getContractFactory("SimpleERC20");
    const token = await Token.deploy("MyToken", "MTK", 1_000_000);
    await token.waitForDeployment();
    return { token, owner, alice, bob };
  }

  it("transfer emits event and updates balance", async () => {
    const { token, owner, alice } = await deploy();
    await expect(token.transfer(alice.address, 100))
      .to.emit(token, "Transfer")
      .withArgs(owner.address, alice.address, 100);
    expect(await token.balanceOf(alice.address)).to.equal(100);
  });

  it("reverts when insufficient balance", async () => {
    const { token, alice, bob } = await deploy();
    await expect(token.connect(alice).transfer(bob.address, 1))
      .to.be.revertedWith("Insufficient balance");
  });
});
```

### 2.3 主网分叉测试（对真实协议做回归）

```ts
// hardhat.config.ts
networks: {
  hardhat: {
    forking: { url: process.env.MAINNET_RPC!, blockNumber: 18_000_000 }
  }
}

// test/uniswap.integration.spec.ts
import { ethers } from "hardhat";

describe("Uniswap mainnet fork", () => {
  it("quotes 1 WETH -> USDC", async () => {
    const router = await ethers.getContractAt(
      "IUniswapV2Router02",
      "0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D"
    );
    const WETH = "0xC02aa..."; const USDC = "0xA0b8...";
    const out = await router.getAmountsOut(ethers.parseEther("1"), [WETH, USDC]);
    expect(out[1]).to.be.gt(0n);
  });
});
```

### 2.4 状态控制（时间/区块/账户/存储）

```ts
import { time, mine } from "@nomicfoundation/hardhat-toolbox/network-helpers";

await time.increase(3600);                 // +1小时
await time.setNextBlockTimestamp(1700000); // 指定时间戳
await mine(100);                           // 挖100个块
await network.provider.send("hardhat_impersonateAccount", [addr]);
```

### 2.5 覆盖率与Gas报告

```bash
npm i -D solidity-coverage hardhat-gas-reporter
npx hardhat coverage
REPORT_GAS=true npx hardhat test
```

## 第三章：E2E自动化（Playwright + 钱包）

### 3.1 选择Playwright的理由

- 多浏览器引擎（Chromium/Firefox/WebKit）
- 原生并发与CI支持
- 配合插件可驱动MetaMask/WalletConnect

### 3.2 环境与依赖

```bash
npm i -D @playwright/test @synthetixio/synpress # 或 metamask-testing/puppeteer-plugin
npx playwright install
```

### 3.3 基本用例：连接钱包并发送交易

```ts
// tests/e2e/wallet.spec.ts
import { test, expect } from "@playwright/test";

// 假设已通过Synpress配置Metamask
test("connect wallet and transfer", async ({ page }) => {
  await page.goto("http://localhost:3000");
  await page.getByRole("button", { name: /connect/i }).click();
  // 切换到MetaMask弹窗并批准（Synpress会处理）

  await page.getByPlaceholder("Recipient Address").fill("0xabc...");
  await page.getByPlaceholder("Amount").fill("0.01");
  await page.getByRole("button", { name: /send/i }).click();

  // 断言交易状态
  await expect(page.getByText(/transaction confirmed/i)).toBeVisible();
});
```

### 3.4 场景库（可直接复用）

- 钱包连接/断开、网络切换（主网/测试网/L2）
- 合约写入交易（approve/transfer/mint）
- 事件监听后的UI变化
- 失败场景：余额不足、gas过低、用户拒签
- 重试与幂等：Pending超时与重新广播

### 3.5 Mock与沙箱

- 使用本地Hardhat节点 + 预置账户
- 通过RPC拦截模拟错误码（-32000/INSUFFICIENT_FUNDS）
- 设定确定性区块时间，避免测试不稳定

## 第四章：SDK/API自动化（Ethers/Viem/后端服务）

### 4.1 SDK契约测试

```ts
import { ethers } from "ethers";
import { describe, it } from "node:test";

it("encodes transfer calldata correctly", () => {
  const iface = new ethers.Interface([
    "function transfer(address to, uint256 amount)"
  ]);
  const data = iface.encodeFunctionData("transfer", ["0xabc...", 123n]);
  expect(data.startsWith("0xa9059cbb")).toBeTruthy();
});
```

### 4.2 后端索引/子图测试（Graph）

- 部署本地Graph节点，订阅事件 → 验证实体写入
- 回放链上事件（从创世块或特定区块）
- 断言分页、排序、过滤正确性

## 第五章：自动化工程化与CI/CD

### 5.1 测试数据与环境管理

- 层级：dev（分叉）/ testnet / staging / mainnet shadow
- 一致性：固定区块高度、固定账户资金
- 秘钥管理：使用CI密钥库，绝不落盘

### 5.2 CI流水线示例（GitHub Actions）

```yaml
name: web3-ci
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - run: npx hardhat compile
      - run: npx hardhat test
      - run: REPORT_GAS=true npx hardhat test
      - run: npx hardhat coverage
```

### 5.3 质量门禁

- 覆盖率阈值：语句≥90%，分支≥80%
- Gas预算：关键函数Gas回归不得上升>5%
- 静态分析：solhint、slither（在CI执行）

## 第六章：安全自动化与扫描

### 6.1 静态分析

```bash
npm i -D solhint
npx solhint 'contracts/**/*.sol'
# Slither（需Python环境）
pipx install slither-analyzer
slither .
```

### 6.2 形式化验证（选学）

- Certora、Scribble/VerX、Echidna（模糊测试）

```bash
# Echidna示例
forge install crytic/echidna
# 编写property函数后运行
```

### 6.3 常见规则集（可落地）

- 外部调用必须遵循 Checks-Effects-Interactions
- 不允许使用tx.origin鉴权
- 不允许可升级合约的初始化器被重复调用
- 代币转账必须检查返回值（非标准ERC20）

## 第七章：可观测性与回归

### 7.1 上线后监控

- 事件监控：关键事件（Mint/Burn/Withdraw）
- 异常监控：revert率、Pending超时、失败交易
- 经济监控：TVL、价格来源、预言机偏差

### 7.2 回归测试触发

- 合约参数变更
- 外部依赖（预言机、DEX、桥）升级
- 节点软件/客户端版本升级（geth/erigon）

## 第八章：最佳实践清单（可打印）

- [ ] 单元/集成/E2E分层清晰
- [ ] 主网分叉覆盖关键路径
- [ ] 所有写入函数包含失败用例
- [ ] 事件断言覆盖核心状态变更
- [ ] Gas报告纳入CI，建立预算阈值
- [ ] 静态分析与格式化强制通过
- [ ] 钱包E2E覆盖连接/签名/拒签/网络切换
- [ ] 测试数据可复现、确定性
- [ ] 私钥/助记词从不落盘，统一密管
- [ ] 关键依赖变更即触发回归

---

> 结语：自动化是WEB3质量保障的核心资产。让测试像协议一样可组合、可复用、可审计。
